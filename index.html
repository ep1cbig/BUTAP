<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BUTAPP - Sebastian Manduca</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3299/3299935.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0fdf4; margin: 0; padding: 0; overflow-x: hidden; }
        .camera-container { position: relative; width: 100%; max-width: 500px; aspect-ratio: 3/4; overflow: hidden; border-radius: 24px; background: #000; margin-bottom: 20px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        video { width: 100%; height: 100%; object-fit: cover; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; border: 2px solid rgba(255,255,255,0.1); border-radius: 24px; }
        .scan-line { position: absolute; width: 100%; height: 2px; background: #22c55e; top: 0; animation: scan 3s linear infinite; box-shadow: 0 0 15px #22c55e; }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }
    </style>
</head>
<body class="p-4 flex flex-col items-center">

    <header class="text-center mb-6">
        <h1 class="text-4xl font-extrabold text-green-700 tracking-tighter">BUTAPP</h1>
        <p class="text-[10px] text-green-600 font-bold uppercase tracking-widest">Sebastian Manduca &copy; 2026</p>
    </header>

    <div class="camera-container">
        <video id="video" autoplay playsinline muted></video>
        <div class="overlay"><div class="scan-line"></div></div>
        
        <div id="setup-layer" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-900 text-white p-6 text-center z-10">
            <div class="mb-4 bg-green-600 p-4 rounded-full shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
            </div>
            <p class="font-bold text-lg mb-2">Activación Necesaria</p>
            <p class="text-sm text-gray-400 mb-6 px-4">Toca el botón para iniciar la detección inteligente de residuos.</p>
            <button onclick="startCamera()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-10 rounded-2xl transition-all active:scale-95 shadow-xl">
                ABRIR CÁMARA
            </button>
        </div>

        <div id="loading-model" class="absolute inset-0 flex flex-col items-center justify-center bg-black/80 text-white text-sm px-6 text-center hidden z-20">
            <div class="w-10 h-10 border-4 border-green-500 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="font-semibold">Cargando IA Ambiental...</p>
        </div>

        <div id="prediction-box" class="absolute bottom-6 left-1/2 -translate-x-1/2 bg-white/95 backdrop-blur-md px-6 py-3 rounded-2xl shadow-2xl text-center min-w-[220px] hidden border border-green-100 z-30">
            <p id="prediction-text" class="text-xl font-black text-gray-800 uppercase">Analizando...</p>
        </div>
    </div>

    <div class="w-full max-w-md bg-white p-6 rounded-[32px] shadow-xl border border-green-50">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h2 id="title-calendar" class="text-xl font-black text-gray-800">Calendario Hoy</h2>
                <p id="date-text" class="text-[10px] text-green-600 font-bold uppercase tracking-widest"></p>
            </div>
            <button onclick="speakToday()" class="w-12 h-12 bg-green-600 rounded-2xl flex items-center justify-center active:scale-90 shadow-lg transition-colors hover:bg-green-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 5L6 9H2v6h4l5 4V5z"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
            </button>
        </div>
        
        <div class="p-5 bg-green-50 rounded-2xl border-2 border-dashed border-green-200 text-center">
            <p id="waste-text" class="text-2xl font-black text-green-900 leading-tight tracking-tight">Cargando fecha...</p>
        </div>
        
        <div class="mt-6 flex gap-3">
            <button onclick="setLanguage('es')" id="btn-es" class="flex-1 py-3 rounded-xl text-xs font-black uppercase tracking-widest border transition-all duration-300">Español</button>
            <button onclick="setLanguage('it')" id="btn-it" class="flex-1 py-3 rounded-xl text-xs font-black uppercase tracking-widest border transition-all duration-300">Italiano</button>
        </div>
    </div>

    <script>
        let currentLang = 'es';
        let model = null;
        const video = document.getElementById('video');

        const translations = {
            es: { today: "Hoy se tira:", speechPrefix: "Atención, hoy te toca tirar ", speechNone: "Atención, hoy no se tira nada.", none: "Nada hoy", scanning: "Escaneando..." },
            it: { today: "Oggi si butta:", speechPrefix: "Attenzione, oggi devi buttare ", speechNone: "Attenzione, oggi non si butta niente.", none: "Niente oggi", scanning: "Analisi..." }
        };

        const calendar = {
            "0-2": "Secco Residuo / Vetro", "0-3": "Organico", "0-5": "Organico", "0-7": "Carta / Plastica Metalli",
            "0-8": "Organico", "0-9": "Secco Residuo / Vetro", "0-10": "Organico", "0-12": "Organico",
            "0-13": "Carta", "0-14": "Plastica Metalli", "0-15": "Organico", "0-16": "Secco Residuo / Vetro",
            "0-31": "Organico"
        };

        const wasteMappingIA = {
            "bottle": "Plastica / Vetro", "water bottle": "Plastica", "wine bottle": "Vetro",
            "cup": "Plastica", "paper": "Carta", "cardboard": "Carta", "can": "Metalli", 
            "orange": "Organico", "banana": "Organico", "apple": "Organico", "food": "Organico"
        };

        async function startCamera() {
            document.getElementById('setup-layer').classList.add('hidden');
            document.getElementById('loading-model').classList.remove('hidden');
            
            try {
                // Versión flexible de constraints para evitar el error de "NotReadableError"
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: "environment",
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    },
                    audio: false 
                });
                video.srcObject = stream;
                await loadAI();
            } catch (err) {
                console.error("Error detallado:", err);
                alert("Error de cámara: Por favor, asegúrate de estar usando HTTPS y de haber cerrado otras apps que usen la cámara.");
                document.getElementById('setup-layer').classList.remove('hidden');
                document.getElementById('loading-model').classList.add('hidden');
            }
        }

        async function loadAI() {
            try {
                model = await mobilenet.load();
                document.getElementById('loading-model').classList.add('hidden');
                document.getElementById('prediction-box').classList.remove('hidden');
                detect();
            } catch (e) {
                alert("Error cargando el modelo de IA.");
            }
        }

        async function detect() {
            if (model && video.readyState === 4) {
                const predictions = await model.classify(video);
                if (predictions.length > 0) {
                    const top = predictions[0].className.toLowerCase();
                    let found = translations[currentLang].scanning;
                    for (let key in wasteMappingIA) {
                        if (top.includes(key)) { found = wasteMappingIA[key]; break; }
                    }
                    document.getElementById('prediction-text').innerText = found;
                }
            }
            requestAnimationFrame(detect);
        }

        function setLanguage(lang) {
            currentLang = lang;
            document.getElementById('btn-es').className = `flex-1 py-3 rounded-xl text-xs font-black border transition-all ${lang === 'es' ? 'bg-green-600 text-white shadow-lg' : 'bg-white text-green-700'}`;
            document.getElementById('btn-it').className = `flex-1 py-3 rounded-xl text-xs font-black border transition-all ${lang === 'it' ? 'bg-green-600 text-white shadow-lg' : 'bg-white text-green-700'}`;
            updateUI();
        }

        function updateUI() {
            const now = new Date();
            const key = `${now.getMonth()}-${now.getDate()}`;
            document.getElementById('waste-text').innerText = calendar[key] || translations[currentLang].none;
            document.getElementById('date-text').innerText = now.toLocaleDateString(currentLang === 'es' ? 'es-ES' : 'it-IT', { weekday: 'long', day: 'numeric', month: 'long' });
            document.getElementById('title-calendar').innerText = translations[currentLang].today;
        }

        function speakToday() {
            const waste = document.getElementById('waste-text').innerText;
            let textToSpeak = "";

            if (waste === translations[currentLang].none) {
                textToSpeak = translations[currentLang].speechNone;
            } else {
                textToSpeak = translations[currentLang].speechPrefix + waste;
            }

            const msg = new SpeechSynthesisUtterance(textToSpeak);
            msg.lang = currentLang === 'es' ? 'es-ES' : 'it-IT';
            msg.rate = 0.9; // Un poco más lento para que se entienda bien
            window.speechSynthesis.speak(msg);
        }

        window.onload = () => setLanguage('es');
    </script>
</body>
</html>
